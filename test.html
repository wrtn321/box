<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crack ìš”ì•½ ë©”ëª¨ë¦¬ í¸ì§‘ê¸°</title>
    <!-- SortableJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5; --primary-light-color: #e0e7ff; --border-color: #ddd;
            --background-light: #f4f4f4; --background-white: #fff; --text-dark: #333; --text-light: #666;
            --green-color: #16a34a; --red-color: #dc2626;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background-color: var(--background-light); color: var(--text-dark); display: flex; flex-direction: column; height: 100vh; }
        .header { display: flex; align-items: center; gap: 10px; background-color: var(--background-white); padding: 10px 15px; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 10; }
        #search-input { flex-grow: 1; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .settings-menu { position: relative; }
        #settings-button { background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px; line-height: 1; color: var(--text-light); }
        #settings-dropdown { display: none; position: absolute; right: 0; top: 100%; background-color: var(--background-white); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; min-width: 200px; padding: 5px 0; }
        #settings-dropdown button { display: block; width: 100%; padding: 10px 15px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; }
        #settings-dropdown button:hover { background-color: #f0f0f0; }
        #delete-tab-button { color: var(--red-color); }

        .tabs-container { padding: 0 10px; background-color: var(--background-white); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 5px; overflow-x: auto; flex-shrink: 0; }
        .tab { padding: 12px 15px; cursor: pointer; border-bottom: 3px solid transparent; font-size: 15px; white-space: nowrap; }
        .tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
        
        .add-tab-menu { position: relative; }
        #add-file-button { font-size: 24px; font-weight: bold; color: var(--primary-color); padding: 5px 15px; cursor: pointer; border-radius: 5px; }
        #add-file-button:hover { background-color: #f0f0f0; }
        #add-tab-dropdown { display: none; position: absolute; left: 0; top: 100%; background-color: var(--background-white); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; min-width: 180px; padding: 5px 0; }
        #add-tab-dropdown button { display: block; width: 100%; padding: 10px 15px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; }
        #add-tab-dropdown button:hover { background-color: #f0f0f0; }

        .main-container { flex: 1; overflow-y: auto; padding: 20px; }
        .file-loader { padding: 40px 20px; text-align: center; }
        .file-loader-label { display: inline-block; background: var(--primary-color); color: white; padding: 15px 30px; border-radius: 8px; cursor: pointer; margin-bottom: 15px; font-size: 16px; }
        #file-input { display: none; }

        /* ì•„ì½”ë””ì–¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .note-item { background: var(--background-white); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; transition: box-shadow 0.2s; }
        .note-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .note-header { display: flex; align-items: center; gap: 10px; padding: 12px; cursor: pointer; }
        .drag-handle { cursor: grab; font-size: 18px; color: #aaa; }
        .note-title-input { flex-grow: 1; border: none; font-size: 16px; font-weight: 600; padding: 5px; border-radius: 4px; }
        .note-title-input:focus { outline: none; background-color: #f0f0f0; }
        .note-actions button { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-light); padding: 5px; }
        .note-body { display: none; padding: 0 15px 15px; border-top: 1px solid #eee; }
        .note-content-textarea { width: 100%; box-sizing: border-box; min-height: 150px; resize: vertical; padding: 10px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; line-height: 1.6; font-family: inherit; }
        .note-item.expanded > .note-body { display: block; }
        
        .sortable-ghost { opacity: 0.4; background: var(--primary-light-color); }
    </style>
</head>
<body>
    <header class="header">
        <input type="text" id="search-input" placeholder="íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”..." disabled>
        <div class="settings-menu" id="settings-menu" style="display: none;">
            <button id="settings-button" title="ì„¤ì •">âš™ï¸</button>
            <div id="settings-dropdown">
                <button id="export-tab-button">ğŸ’¾ í˜„ì¬ íƒ­ ë‹¤ìš´ë¡œë“œ (.json)</button>
                <button id="delete-tab-button">ğŸ—‘ï¸ í˜„ì¬ íƒ­ ì‚­ì œ</button>
            </div>
        </div>
    </header>

    <div class="tabs-container" id="tabs-container"></div>

    <main class="main-container" id="main-container">
        <div id="initial-loader" class="file-loader">
            <label for="file-input" class="file-loader-label">JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</label>
            <input type="file" id="file-input" accept=".json" multiple>
            <p>wrtn í¬ë™ì—ì„œ ë°±ì—…í•œ ìš”ì•½ ë©”ëª¨ë¦¬ json íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>
        <div id="notes-list-container"></div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const LOCAL_STORAGE_KEY = 'crackMemoryEditorData';
        const getEl = (id) => document.getElementById(id);
        
        // DOM Elements
        const fileInput = getEl('file-input'), searchInput = getEl('search-input'), tabsContainer = getEl('tabs-container');
        const mainContainer = getEl('main-container'), initialLoader = getEl('initial-loader'), notesListContainer = getEl('notes-list-container');
        const settingsMenu = getEl('settings-menu'), settingsButton = getEl('settings-button'), settingsDropdown = getEl('settings-dropdown');
        const exportTabButton = getEl('export-tab-button'), deleteTabButton = getEl('delete-tab-button');
        
        let loadedData = {}, activeTab = null, sortableInstance = null;

        const saveDataToLocal = () => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(loadedData));
        
        const loadDataFromLocal = () => {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                loadedData = JSON.parse(savedData);
            }
            const filenames = Object.keys(loadedData);
            tabsContainer.innerHTML = '';
            createAddFileTab(); // + ë²„íŠ¼ ë©”ë‰´ ìƒì„±
            if (filenames.length > 0) {
                setupUIForLoadedData();
                filenames.forEach(createTab);
                switchTab(filenames[0]);
            }
        };

        const setupUIForLoadedData = () => {
            initialLoader.style.display = 'none';
            settingsMenu.style.display = 'block';
            searchInput.disabled = false;
            searchInput.placeholder = 'ì œëª© ë˜ëŠ” ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰...';
        };
        
        const createAddFileTab = () => {
            const menuContainer = document.createElement('div');
            menuContainer.className = 'add-tab-menu';

            const addButton = document.createElement('div');
            addButton.id = 'add-file-button'; 
            addButton.textContent = '+'; 
            addButton.title = 'íŒŒì¼ ì¶”ê°€ ë˜ëŠ” ìƒˆ íƒ­ ìƒì„±';
            
            const dropdown = document.createElement('div');
            dropdown.id = 'add-tab-dropdown';

            const loadFileButton = document.createElement('button');
            loadFileButton.textContent = 'ğŸ“‚ JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°';
            loadFileButton.onclick = () => { fileInput.click(); dropdown.style.display = 'none'; };

            const newTabButton = document.createElement('button');
            newTabButton.textContent = 'ğŸ“„ ë¹ˆ íƒ­ ì¶”ê°€';
            newTabButton.onclick = () => { addNewTab(); dropdown.style.display = 'none'; };

            dropdown.appendChild(loadFileButton);
            dropdown.appendChild(newTabButton);
            menuContainer.appendChild(addButton);
            menuContainer.appendChild(dropdown);

            addButton.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });
            tabsContainer.appendChild(menuContainer);
        };

        const handleFileSelect = (event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            setupUIForLoadedData();
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // ìœ ì €ìŠ¤í¬ë¦½íŠ¸ JSON êµ¬ì¡°ì— ë§ì¶° longTerm ë°ì´í„° ì¶”ì¶œ
                        const notesArray = data.longTerm && Array.isArray(data.longTerm) ? data.longTerm : [];
                        
                        if (data.longTerm === undefined) {
                           alert(`'${file.name}' íŒŒì¼ì— 'longTerm' ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                           return;
                        }

                        const filename = file.name;
                        loadedData[filename] = notesArray.map(item => ({ title: item.title, summary: item.summary }));
                        
                        if (!document.querySelector(`.tab[data-filename="${filename}"]`)) createTab(filename);
                        saveDataToLocal();
                        switchTab(filename);
                    } catch (err) { alert(`'${file.name}' ì²˜ë¦¬ ì˜¤ë¥˜: ìœ íš¨í•œ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.`); }
                };
                reader.readAsText(file);
            });
            fileInput.value = '';
        };

        const createTab = (filename) => {
            const tabName = filename.replace('.json', '');
            const tab = document.createElement('div');
            tab.className = 'tab'; tab.textContent = tabName; tab.dataset.filename = filename;
            tab.addEventListener('click', () => switchTab(filename));
            tabsContainer.insertBefore(tab, tabsContainer.querySelector('.add-tab-menu'));
        };

        const switchTab = (filename) => {
            activeTab = filename;
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.filename === filename));
            renderNotesList(loadedData[filename] || []);
        };

        const renderNotesList = (notes) => {
            notesListContainer.innerHTML = '';
            if (notes.length === 0) {
                notesListContainer.textContent = 'í‘œì‹œí•  ì¥ê¸°ê¸°ì–µì´ ì—†ìŠµë‹ˆë‹¤. í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ìƒˆ ë…¸íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            notes.forEach((note, index) => {
                const item = document.createElement('div');
                item.className = 'note-item';
                item.dataset.index = index;

                const header = document.createElement('div');
                header.className = 'note-header';
                
                header.innerHTML = `
                    <span class="drag-handle">â˜°</span>
                    <input type="text" class="note-title-input" value="${note.title || ''}" placeholder="ì œëª©">
                    <div class="note-actions">
                        <button class="delete-note-button" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </div>
                `;
                
                const body = document.createElement('div');
                body.className = 'note-body';
                body.innerHTML = `<textarea class="note-content-textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">${note.summary || ''}</textarea>`;

                item.appendChild(header);
                item.appendChild(body);
                notesListContainer.appendChild(item);

                // Event Listeners for inline editing and actions
                header.addEventListener('click', (e) => {
                    if (!e.target.closest('input, button')) {
                        item.classList.toggle('expanded');
                    }
                });

                const titleInput = item.querySelector('.note-title-input');
                titleInput.addEventListener('input', () => {
                    loadedData[activeTab][index].title = titleInput.value;
                    saveDataToLocal();
                });

                const contentTextarea = item.querySelector('.note-content-textarea');
                contentTextarea.addEventListener('input', () => {
                    loadedData[activeTab][index].summary = contentTextarea.value;
                    saveDataToLocal();
                });

                const deleteButton = item.querySelector('.delete-note-button');
                deleteButton.addEventListener('click', () => {
                    if (confirm(`'${note.title}' í•­ëª©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        loadedData[activeTab].splice(index, 1);
                        saveDataToLocal();
                        renderNotesList(loadedData[activeTab]);
                    }
                });
            });
            
            // Initialize SortableJS
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            sortableInstance = new Sortable(notesListContainer, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    const [movedItem] = loadedData[activeTab].splice(evt.oldIndex, 1);
                    loadedData[activeTab].splice(evt.newIndex, 0, movedItem);
                    saveDataToLocal();
                    renderNotesList(loadedData[activeTab]); // Re-render to fix indices
                },
            });
        };

        const handleSearch = (e) => {
            if (!activeTab) return;
            const searchTerm = e.target.value.toLowerCase();
            const allNotes = loadedData[activeTab] || [];
            if (searchTerm === '') {
                renderNotesList(allNotes);
                return;
            }
            const filteredNotes = allNotes.filter(note =>
                (note.title && note.title.toLowerCase().includes(searchTerm)) ||
                (note.summary && note.summary.toLowerCase().includes(searchTerm))
            );
            renderNotesList(filteredNotes);
        };
        
        const addNewTab = () => {
            const tabName = prompt("ìƒˆ íƒ­ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (!tabName || tabName.trim() === '') return;
            const filename = tabName.trim() + '.json';
            if (loadedData[filename]) {
                alert("ì˜¤ë¥˜: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒ­ ì´ë¦„ì…ë‹ˆë‹¤.");
                return;
            }
            loadedData[filename] = [{ title: "ìƒˆë¡œìš´ ê¸°ì–µ", summary: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." }];
            saveDataToLocal();
            createTab(filename);
            switchTab(filename);
        };

        const exportTabData = () => {
            if (!activeTab) return;
            const dataToExport = {
                longTerm: loadedData[activeTab] || []
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = activeTab;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        };
        
        const deleteCurrentTab = () => {
            if (!activeTab || !confirm(`'${activeTab.replace('.json','')}' íƒ­ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.`)) return;
            delete loadedData[activeTab];
            saveDataToLocal();
            location.reload();
        };

        // Event Listeners
        fileInput.addEventListener('change', handleFileSelect);
        searchInput.addEventListener('input', handleSearch);
        settingsButton.addEventListener('click', (e) => { e.stopPropagation(); settingsDropdown.style.display = settingsDropdown.style.display === 'block' ? 'none' : 'block'; });
        document.addEventListener('click', () => { 
            settingsDropdown.style.display = 'none';
            const addDropdown = getEl('add-tab-dropdown');
            if(addDropdown) addDropdown.style.display = 'none';
        });
        exportTabButton.addEventListener('click', exportTabData);
        deleteTabButton.addEventListener('click', deleteCurrentTab);
        
        loadDataFromLocal();
    });
    </script>
</body>
</html>
