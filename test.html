<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crack ìš”ì•½ ë©”ëª¨ë¦¬ í¸ì§‘ê¸°</title>
    <!-- SortableJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5; --primary-light-color: #e0e7ff; --border-color: #e5e7eb;
            --background-light: #f9fafb; --background-white: #fff; --text-dark: #1f2937; --text-light: #6b7280;
            --green-color: #16a34a; --red-color: #dc2626; --blue-color: #2563eb;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background-color: var(--background-light); color: var(--text-dark); }
        .header { display: flex; align-items: center; gap: 10px; background-color: var(--background-white); padding: 10px 20px; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        #search-input { flex-grow: 1; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .header-actions button { background-color: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; white-space: nowrap; }
        .tabs-container { padding: 0 15px; background-color: var(--background-white); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 5px; overflow-x: auto; flex-wrap: nowrap; }
        .tab { padding: 12px 15px; cursor: pointer; border-bottom: 3px solid transparent; font-size: 15px; white-space: nowrap; color: var(--text-light); }
        .tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
        #add-file-tab { font-size: 24px; font-weight: bold; color: var(--primary-color); padding: 5px 15px; cursor: pointer; border-radius: 5px; }
        #add-file-tab:hover { background-color: #f0f0f0; }
        main { padding: 20px; max-width: 900px; margin: 0 auto; }
        .file-loader { padding: 40px 20px; text-align: center; background-color: var(--background-white); border-radius: 8px; border: 2px dashed var(--border-color); }
        .file-loader-label { display: inline-block; background: var(--primary-color); color: white; padding: 15px 30px; border-radius: 8px; cursor: pointer; margin-bottom: 15px; font-size: 16px; }
        #file-input { display: none; }
        .note-item { background-color: var(--background-white); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        .note-header { display: flex; align-items: center; padding: 15px; cursor: pointer; user-select: none; }
        .drag-handle { cursor: grab; font-size: 20px; color: var(--text-light); padding-right: 15px; }
        .note-title-text { font-weight: 600; flex-grow: 1; }
        .note-char-count { font-size: 12px; color: var(--text-light); background-color: #f3f4f6; padding: 3px 8px; border-radius: 10px; margin-left: 10px; }
        .note-content { display: none; padding: 0 20px 20px 20px; border-top: 1px solid var(--border-color); }
        .note-item.expanded .note-content { display: block; }
        .note-summary { white-space: pre-wrap; word-wrap: break-word; font-size: 15px; line-height: 1.7; padding: 15px; background-color: #f9fafb; border-radius: 5px; margin-bottom: 15px; }
        .edit-area textarea { width: 100%; box-sizing: border-box; padding: 10px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; font-family: inherit; min-height: 150px; resize: vertical; line-height: 1.7; }
        .actions-container { display: flex; gap: 10px; justify-content: flex-end; }
        .action-button { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-edit { background-color: var(--blue-color); color: white; }
        .btn-delete { background-color: var(--red-color); color: white; }
        .btn-save { background-color: var(--green-color); color: white; }
        .btn-cancel { background-color: var(--text-light); color: white; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header class="header">
        <input type="text" id="search-input" placeholder="íŒŒì¼ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”..." disabled>
        <div class="header-actions">
            <button id="add-note-button" style="display: none;">+ ìƒˆ ê¸°ì–µ ì¶”ê°€</button>
            <button id="export-tab-button" style="display: none;">í˜„ì¬ íƒ­ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </header>

    <div class="tabs-container" id="tabs-container"></div>

    <main id="main-container">
        <div id="initial-loader" class="file-loader">
            <label for="file-input" class="file-loader-label">Crack ë°±ì—… JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</label>
            <input type="file" id="file-input" accept=".json" multiple>
            <p>ë°±ì—…í•œ `[ìš”ì•½ë©”ëª¨ë¦¬]...json` íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”.</p>
        </div>
        <div id="notes-container"></div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const LOCAL_STORAGE_KEY = 'crackMemoryEditorData';
        const getEl = id => document.getElementById(id);

        // DOM Elements
        const fileInput = getEl('file-input'), searchInput = getEl('search-input');
        const tabsContainer = getEl('tabs-container'), mainContainer = getEl('main-container');
        const initialLoader = getEl('initial-loader'), notesContainer = getEl('notes-container');
        const addNoteButton = getEl('add-note-button'), exportTabButton = getEl('export-tab-button');

        let loadedData = {}, activeTab = null;

        const saveDataToLocal = () => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(loadedData));

        const loadDataFromLocal = () => {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) loadedData = JSON.parse(savedData);
            tabsContainer.innerHTML = '';
            createAddFileTab();
            const filenames = Object.keys(loadedData);
            if (filenames.length > 0) {
                setupUIForLoadedData();
                filenames.forEach(createTab);
                switchTab(filenames[0]);
            }
        };

        const setupUIForLoadedData = () => {
            initialLoader.style.display = 'none';
            searchInput.disabled = false;
            searchInput.placeholder = 'ì œëª© ë˜ëŠ” ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰...';
            addNoteButton.style.display = 'inline-block';
            exportTabButton.style.display = 'inline-block';
        };

        const createAddFileTab = () => {
            const addTab = document.createElement('div');
            addTab.id = 'add-file-tab'; addTab.textContent = 'ğŸ“‚+'; addTab.title = 'íŒŒì¼ ì¶”ê°€í•˜ê¸°';
            addTab.onclick = () => fileInput.click();
            tabsContainer.appendChild(addTab);
        };

        const handleFileSelect = event => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // ìœ ì €ìŠ¤í¬ë¦½íŠ¸ JSON í˜•ì‹ í™•ì¸ ë° ë°ì´í„° ì¶”ì¶œ
                        if (data && typeof data === 'object' && Array.isArray(data.longTerm)) {
                            const filename = file.name;
                            // summaryë¥¼ contentë¡œ ë§¤í•‘í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
                            loadedData[filename] = data.longTerm.map(item => ({
                                title: item.title,
                                summary: item.summary
                                // ë‹¤ë¥¸ ì†ì„±ë“¤ì€ ìœ ì§€
                            }));

                            if (!document.querySelector(`.tab[data-filename="${filename}"]`)) createTab(filename);
                            saveDataToLocal();
                            if(!activeTab) {
                                setupUIForLoadedData();
                                switchTab(filename);
                            } else {
                                switchTab(filename);
                            }
                        } else {
                            throw new Error('longTerm ë°°ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } catch (err) {
                        alert(`'${file.name}' ì²˜ë¦¬ ì˜¤ë¥˜: ìœ íš¨í•œ Crack ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.\n(${err.message})`);
                    }
                };
                reader.readAsText(file);
            });
            fileInput.value = '';
        };

        const createTab = (filename) => {
            const tabName = filename.replace('.json', '');
            const tab = document.createElement('div');
            tab.className = 'tab'; tab.textContent = tabName; tab.dataset.filename = filename;
            tab.addEventListener('click', () => switchTab(filename));
            tabsContainer.insertBefore(tab, getEl('add-file-tab'));
        };

        const switchTab = filename => {
            activeTab = filename;
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.filename === filename));
            renderNotes(loadedData[activeTab] || []);
        };

        const renderNotes = (notes) => {
            notesContainer.innerHTML = '';
            if (!notes) return;

            notes.forEach((note, index) => {
                const item = document.createElement('div');
                item.className = 'note-item';
                item.dataset.index = index;

                const summaryLength = note.summary?.length || 0;
                
                item.innerHTML = `
                    <div class="note-header">
                        <span class="drag-handle">â ¿</span>
                        <span class="note-title-text">${note.title || 'ì œëª© ì—†ìŒ'}</span>
                        <span class="note-char-count">${summaryLength}ì</span>
                    </div>
                    <div class="note-content">
                        <div class="view-area">
                            <pre class="note-summary">${note.summary || ''}</pre>
                            <div class="actions-container">
                                <button class="action-button btn-edit">ìˆ˜ì •</button>
                                <button class="action-button btn-delete">ì‚­ì œ</button>
                            </div>
                        </div>
                        <div class="edit-area" style="display: none;">
                            <textarea class="edit-summary-input">${note.summary || ''}</textarea>
                            <div class="actions-container">
                                <button class="action-button btn-save">ì €ì¥</button>
                                <button class="action-button btn-cancel">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>
                `;
                notesContainer.appendChild(item);
            });
            attachNoteEventListeners();
        };
        
        const attachNoteEventListeners = () => {
            document.querySelectorAll('.note-item').forEach(item => {
                const index = parseInt(item.dataset.index, 10);
                const header = item.querySelector('.note-header');
                const viewArea = item.querySelector('.view-area');
                const editArea = item.querySelector('.edit-area');

                header.addEventListener('click', e => {
                    // ë“œë˜ê·¸ í•¸ë“¤ì„ í´ë¦­í•œ ê²½ìš°ëŠ” í† ê¸€í•˜ì§€ ì•ŠìŒ
                    if (e.target.classList.contains('drag-handle')) return;
                    item.classList.toggle('expanded');
                });
                
                item.querySelector('.btn-edit').addEventListener('click', () => {
                    viewArea.style.display = 'none';
                    editArea.style.display = 'block';
                });

                item.querySelector('.btn-cancel').addEventListener('click', () => {
                    editArea.style.display = 'none';
                    viewArea.style.display = 'block';
                    // ë³€ê²½ì‚¬í•­ ì·¨ì†Œ (ì›ë˜ ë‚´ìš©ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°)
                    editArea.querySelector('.edit-summary-input').value = loadedData[activeTab][index].summary;
                });
                
                item.querySelector('.btn-save').addEventListener('click', () => {
                    const newSummary = item.querySelector('.edit-summary-input').value;
                    loadedData[activeTab][index].summary = newSummary;
                    saveDataToLocal();
                    renderNotes(loadedData[activeTab]); // ì „ì²´ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ìˆœì„œì™€ ë‚´ìš© ë°˜ì˜
                });
                
                item.querySelector('.btn-delete').addEventListener('click', () => {
                    if (confirm(`'${loadedData[activeTab][index].title}' ê¸°ì–µì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        loadedData[activeTab].splice(index, 1);
                        saveDataToLocal();
                        renderNotes(loadedData[activeTab]);
                    }
                });
            });
        };

        const initializeSortable = () => {
            new Sortable(notesContainer, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: evt => {
                    const [movedItem] = loadedData[activeTab].splice(evt.oldIndex, 1);
                    loadedData[activeTab].splice(evt.newIndex, 0, movedItem);
                    saveDataToLocal();
                    renderNotes(loadedData[activeTab]); // ìˆœì„œ ë³€ê²½ í›„ ë‹¤ì‹œ ë Œë”ë§
                },
            });
        };

        const handleSearch = e => {
            if (!activeTab) return;
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.note-item').forEach(item => {
                const index = parseInt(item.dataset.index, 10);
                const note = loadedData[activeTab][index];
                const isVisible = (note.title && note.title.toLowerCase().includes(searchTerm)) ||
                                  (note.summary && note.summary.toLowerCase().includes(searchTerm));
                item.classList.toggle('hidden', !isVisible);
            });
        };

        addNoteButton.addEventListener('click', () => {
            if (!activeTab) return;
            const newTitle = prompt("ìƒˆ ê¸°ì–µì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìƒˆ ê¸°ì–µ");
            if (newTitle) {
                const newNote = { title: newTitle, summary: "" };
                if (!loadedData[activeTab]) loadedData[activeTab] = [];
                loadedData[activeTab].unshift(newNote); // ë§¨ ìœ„ì— ì¶”ê°€
                saveDataToLocal();
                renderNotes(loadedData[activeTab]);
                // ìƒˆë¡œ ì¶”ê°€ëœ í•­ëª©ì„ ë°”ë¡œ í¼ì³ì„œ í¸ì§‘ ëª¨ë“œë¡œ ì§„ì…
                const firstItem = notesContainer.querySelector('.note-item');
                if (firstItem) {
                    firstItem.classList.add('expanded');
                    firstItem.querySelector('.view-area').style.display = 'none';
                    firstItem.querySelector('.edit-area').style.display = 'block';
                    firstItem.querySelector('.edit-summary-input').focus();
                }
            }
        });

        exportTabButton.addEventListener('click', () => {
            if (!activeTab || !loadedData[activeTab]) return;
            // ë‚´ë³´ë‚¼ ë•ŒëŠ” ì›ë³¸ í˜•ì‹ì¸ { longTerm: [...] } ìœ¼ë¡œ ì¬êµ¬ì„±
            const dataToExport = {
                longTerm: loadedData[activeTab]
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = activeTab;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        });

        // Event Listeners
        fileInput.addEventListener('change', handleFileSelect);
        searchInput.addEventListener('input', handleSearch);

        // Initial setup
        loadDataFromLocal();
        initializeSortable();
    });
    </script>
</body>
</html>
