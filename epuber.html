<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB ìŠ¤íŠœë””ì˜¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { margin: 0; font-family: 'Malgun Gothic', sans-serif; display: flex; flex-direction: row; height: 100vh; background-color: #f5f6fa; }
        
        #control-pane { width: 450px; background-color: white; padding: 30px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); overflow-y: auto; z-index: 10; flex-shrink: 0; }
        #preview-pane { flex: 1; background-color: #e1e2e6; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        
        .pane-title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pane-title { font-size: 1.2rem; font-weight: bold; color: #2f3640; margin: 0; }
        
        #preview-content { flex: 1; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); line-height: 1.8; font-size: 15px; }

        .control-group { margin-bottom: 25px; }
        .control-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #353b48; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #dcdde1; border-radius: 4px; box-sizing: border-box; }
        input[type="file"] { display: block; margin-top: 5px; }
        
        #cover-preview-img { max-width: 150px; max-height: 200px; display: none; margin-top: 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .hud-item { display: flex; gap: 8px; margin-bottom: 10px; align-items: flex-start; }
        .hud-checkbox { width: 18px; height: 18px; margin-top: 13px; cursor: pointer; flex-shrink: 0; }
        .hud-input { flex: 1; padding: 10px; border: 1px solid #dcdde1; border-radius: 4px; resize: vertical; box-sizing: border-box; font-family: inherit; min-height: 45px; }
        
        .btn-small { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; }
        .btn-add { background-color: #7bed9f; color: #2f3640; float: right; font-size: 0.9rem;}
        .btn-add:hover { background-color: #2ed573; }
        .btn-remove { background-color: #ff6b81; height: auto; }
        .btn-remove:hover { background-color: #ff4757; }
        .btn-edit { background-color: #3498db; }
        .btn-edit:hover { background-color: #2980b9; }
        button:disabled { opacity: 0.5; cursor: not-allowed !important; }

        .btn { display: block; width: 100%; padding: 15px; background-color: #fbc531; color: #2f3640; text-align: center; font-weight: bold; font-size: 1.1rem; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn:hover { background-color: #e1b12c; }

        .export-container { display: flex; gap: 8px; margin-top: 10px; }
        .btn-export { background-color: #7bed9f; font-size: 0.95rem; flex: 1; padding: 12px; margin: 0; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; color: #2f3640; }
        .btn-export:hover { background-color: #2ed573; }

        .msg-block { position: relative; border-radius: 6px; padding: 10px; margin-bottom: 15px; border: 1px solid transparent; transition: 0.2s; }
        .msg-block:hover { border: 1px dashed #dcdde1; background-color: #fcfcfc; }
        .msg-controls { display: flex; opacity: 0; transition: 0.2s; position: absolute; top: 5px; right: 5px; gap: 5px; z-index: 5; }
        .msg-block:hover .msg-controls { opacity: 1; }
        
        .edit-textarea { width: 100%; box-sizing: border-box; padding: 10px; font-family: inherit; border: 2px solid #3498db; border-radius: 4px; resize: none; overflow: hidden; font-size: 15px; line-height: 1.6; }

        .dropdown-container { position: relative; display: inline-block; }
        .btn-toggle { background: none; border: none; font-size: 1.8rem; font-weight: bold; color: #2f3640; cursor: pointer; padding: 0 10px; transition: 0.2s; }
        .btn-toggle:hover { color: #8e44ad; }
        .dropdown-menu { position: absolute; right: 0; top: 100%; min-width: 260px; background: white; border: 1px solid #dcdde1; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: none; z-index: 100; max-height: 350px; overflow-y: auto; text-align: left; }
        .dropdown-menu.show { display: block; }
        .dropdown-header { padding: 12px; font-weight: bold; border-bottom: 1px solid #eee; cursor: pointer; color: #2f3640; transition: 0.2s; }
        .dropdown-header:hover { background-color: #f5f6fa; color: #8e44ad; }
        .save-item { padding: 10px 12px; border-bottom: 1px solid #f5f6fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .save-item:hover { background-color: #f1f2f6; }
        .save-title-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.9rem; margin-right: 10px; }
        .save-actions { display: none; gap: 8px; }
        .save-item:hover .save-actions { display: flex; }
        
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 0.9rem; padding: 0; opacity: 0.7; transition: 0.2s; }
        .icon-btn:hover { opacity: 1; transform: scale(1.15); }

        .user-text { margin-top: 1.5em; margin-bottom: 1.5em; } 
        .user-divider { border: 0; border-top: 1px dashed #b2bec3; margin: 1.5em 0; }
        .bold { font-weight: bold; }
        .italic { font-style: italic; }
        img.content-img { max-width: 100%; height: auto; display: block; margin: 1.8em auto 0.2em auto; border-radius: 5px; }
        h2.preview-title { text-align: center; } 
        
        .msg-content h1, .msg-content h2, .msg-content h3, .msg-content h4, .msg-content h5, .msg-content h6 { margin: 0.6em 0; line-height: 1.4; color: #2f3640; }

        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; color: white; font-size: 20px; font-weight: bold; flex-direction: column; text-align: center; line-height: 1.6; }
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #fbc531; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #progress-text { font-size: 28px; color: #fbc531; margin-top: 10px; font-weight: 900; }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; }
            #control-pane { width: 100%; box-shadow: none; border-bottom: 2px solid #dcdde1; padding: 20px; box-sizing: border-box; }
            #preview-pane { padding: 10px; }
            #preview-content { padding: 15px; }
            .msg-controls { position: relative; opacity: 1; justify-content: flex-end; margin-top: 5px; top: 0; right: 0; }
            .save-actions { display: flex; } 
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loading-screen">
        <div class="spinner"></div>
        <div id="loading-desc">EPUB í¬ì¥ ë° ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘...ğŸš€<br>ì•ˆì „í•˜ê²Œ 1ê°œì”© ì°¨ë¡€ëŒ€ë¡œ ë‹¤ìš´ë°›ê³  ìˆìŠµë‹ˆë‹¤.</div>
        <div id="progress-text">(0 / 0)</div>
    </div>

    <div id="control-pane">
        <h2 style="margin-top: 0;">EPUB ì„¤ì •</h2>
        <div class="control-group">
            <label>1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (JSON, TXT)</label>
            <input type="file" id="json-file" accept=".json,.txt">
        </div>
        <div class="control-group"><label>2. í‘œì§€ ì´ë¯¸ì§€ (ì„ íƒ)</label><input type="file" id="cover-file" accept="image/*"><img id="cover-preview-img" src="" alt="í‘œì§€ ë¯¸ë¦¬ë³´ê¸°"></div>
        <div class="control-group"><label>3. ì±… ì •ë³´</label><input type="text" id="book-title" placeholder="ì±… ì œëª©" style="margin-bottom: 10px;"><input type="text" id="book-author" placeholder="ì‘ê°€ ì´ë¦„"></div>
        <div class="control-group">
            <label>4. HUD(ìƒíƒœì°½) íŒ¨í„´ <button id="add-hud-btn" class="btn-small btn-add">+ ì¶”ê°€</button></label>
            <p style="font-size: 0.85rem; color: #ff4757; font-weight: bold; margin-top: 0;">â€» ë³€í•˜ëŠ” ë¶€ë¶„ì€ ë‹¬ëŸ¬ 3ê°œ($$$)ë¡œ ì“°ì„¸ìš”!<br>â€» ì²´í¬ë°•ìŠ¤ë¥¼ ë„ë©´ í•´ë‹¹ íŒ¨í„´ì€ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <div id="hud-container"></div>
        </div>
        <div class="control-group">
            <label>5. ì˜µì…˜ ì„¤ì •</label>
            <label style="font-weight: normal; cursor: pointer; display: block; margin-bottom: 10px;"><input type="checkbox" id="user-divider" checked> ìœ ì € ëŒ€ì‚¬ ìœ„ì•„ë˜ë¡œ êµ¬ë¶„ì„ (---) ë„£ê¸°</label>
            <label style="font-weight: normal; cursor: pointer; display: block;"><input type="checkbox" id="remove-img"> '![ì´ë¯¸ì§€](ì£¼ì†Œ)' ë¬¸êµ¬ ì™„ì „ ì‚­ì œ</label>
        </div>
        
        <button class="btn" id="download-btn">âœ¨ EPUB ë‹¤ìš´ë¡œë“œ âœ¨</button>
        
        <p style="font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; margin-top: 15px; color:#2f3640;">ğŸ’¾ ìˆ˜ì •ëœ ë°ì´í„° ì›ë³¸ ë³´ì¡´í•˜ê¸°</p>
        <div class="export-container">
            <button class="btn-export" id="download-json-btn">JSON</button>
            <button class="btn-export" id="download-txt-btn">TXT</button>
        </div>
        <p style="font-size: 0.8rem; text-align: center; color: #7f8fa6; margin-top: 10px;">â€» ì„¤ì •ë§Œ ìë™ ì €ì¥ë˜ë©°, ëŒ€ì‚¬ ë°ì´í„°ëŠ” ë³„ë„ë¡œ ë‹¤ìš´ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.</p>
    </div>

    <div id="preview-pane">
        <div class="pane-title-container">
            <div class="pane-title">ğŸ“– ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° (ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)</div>
            <div class="dropdown-container">
                <button class="btn-toggle" id="save-menu-toggle" title="ì €ì¥ì†Œ ë©”ë‰´">â‹®</button>
                <div id="save-dropdown" class="dropdown-menu">
                    <div class="dropdown-header" id="btn-save-new">ğŸ’¾ ì €ì¥ì†Œì— ìƒˆë¡œ ë§Œë“¤ê¸°</div>
                    <div id="save-list"></div>
                </div>
            </div>
        </div>
        <div id="preview-content">
            <p style="color: #7f8fa6; text-align: center; margin-top: 20vh;">íŒŒì¼(JSON, TXT)ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜<br>ìš°ì¸¡ ìƒë‹¨ [â‹®] ë©”ë‰´ì—ì„œ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // IndexedDB í—¬í¼
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const DB_NAME = 'EpubStudioDB';
        const DB_VERSION = 1;
        let idb;

        const initDB = () => new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('saves')) db.createObjectStore('saves', { keyPath: 'id' });
            };
            req.onsuccess = (e) => { idb = e.target.result; resolve(); };
            req.onerror = (e) => reject(e.target.error);
        });

        const dbPut    = (s, d) => new Promise((res, rej) => { const t = idb.transaction(s,'readwrite'); const r = t.objectStore(s).put(d); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
        const dbGet    = (s, id) => new Promise((res, rej) => { const t = idb.transaction(s,'readonly'); const r = t.objectStore(s).get(id); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
        const dbGetAll = (s) => new Promise((res, rej) => { const t = idb.transaction(s,'readonly'); const r = t.objectStore(s).getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
        const dbDelete = (s, id) => new Promise((res, rej) => { const t = idb.transaction(s,'readwrite'); const r = t.objectStore(s).delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ìƒìˆ˜ / ìƒíƒœ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const MY_PROXY_URL = "https://proxy.wrtn321.workers.dev";

        let currentJsonData    = null;
        let coverFileContent   = null;
        let coverFileName      = null;
        let editingMessageIndex = null;
        let isDirty            = false; // [ìˆ˜ì •] ë¯¸ì €ì¥ ë³€ê²½ ì¶”ì 

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // DOM ë ˆí¼ëŸ°ìŠ¤
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const jsonInput        = document.getElementById('json-file');
        const coverInput       = document.getElementById('cover-file');
        const coverPreviewImg  = document.getElementById('cover-preview-img');
        const titleInput       = document.getElementById('book-title');
        const authorInput      = document.getElementById('book-author');
        const removeImgCheck   = document.getElementById('remove-img');
        const userDividerCheck = document.getElementById('user-divider');
        const previewContent   = document.getElementById('preview-content');
        const downloadBtn      = document.getElementById('download-btn');
        const btnJson          = document.getElementById('download-json-btn');
        const btnTxt           = document.getElementById('download-txt-btn');
        const addHudBtn        = document.getElementById('add-hud-btn');
        const hudContainer     = document.getElementById('hud-container');
        const loadingScreen    = document.getElementById('loading-screen');
        const progressText     = document.getElementById('progress-text');
        const dropdownToggle   = document.getElementById('save-menu-toggle');
        const dropdownMenu     = document.getElementById('save-dropdown');
        const saveNewBtn       = document.getElementById('btn-save-new');
        const saveListContainer= document.getElementById('save-list');

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // [ìˆ˜ì •] í˜ì´ì§€ ì´íƒˆ ê²½ê³ 
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.addEventListener('beforeunload', (e) => {
            if (isDirty && currentJsonData) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function saveSettings() {
            const huds = Array.from(document.querySelectorAll('.hud-item')).map(item => ({
                value:   item.querySelector('.hud-input').value,
                checked: item.querySelector('.hud-checkbox').checked
            })).filter(h => h.value.trim() !== '');

            localStorage.setItem('epubStudioSettings', JSON.stringify({
                huds,
                removeImg:  removeImgCheck.checked,
                useDivider: userDividerCheck.checked
            }));
        }

        function loadSettings() {
            const raw = localStorage.getItem('epubStudioSettings');
            if (raw) {
                const s = JSON.parse(raw);
                removeImgCheck.checked   = s.removeImg  !== undefined ? s.removeImg  : false;
                userDividerCheck.checked = s.useDivider !== undefined ? s.useDivider : true;
                hudContainer.innerHTML = '';
                if (s.huds && s.huds.length > 0) {
                    s.huds.forEach(h => addHudField(typeof h === 'string' ? h : h.value, typeof h === 'string' ? true : h.checked));
                } else { addHudField('', true); }
            } else { addHudField('', true); }

            titleInput.value  = '';
            authorInput.value = '';
            currentJsonData   = null;
        }

        function addHudField(value = '', isChecked = true) {
            const div  = document.createElement('div');
            div.className = 'hud-item';

            const chk = document.createElement('input');
            chk.type = 'checkbox'; chk.className = 'hud-checkbox'; chk.checked = isChecked;
            chk.addEventListener('change', () => { saveSettings(); updatePreview(); });

            const input = document.createElement('textarea');
            input.className = 'hud-input'; input.rows = 2; input.value = value;
            input.placeholder = "ì˜ˆ: **[ $$$ ]**";
            input.addEventListener('input', () => { saveSettings(); updatePreview(); });

            const rmBtn = document.createElement('button');
            rmBtn.className = 'btn-small btn-remove'; rmBtn.textContent = 'X';
            rmBtn.onclick = () => { div.remove(); saveSettings(); updatePreview(); };

            div.appendChild(chk); div.appendChild(input); div.appendChild(rmBtn);
            hudContainer.appendChild(div);
            saveSettings(); updatePreview();
        }

        addHudBtn.addEventListener('click', () => addHudField('', true));

        [titleInput, authorInput, removeImgCheck, userDividerCheck].forEach(el => {
            el.addEventListener('input', () => { saveSettings(); updatePreview(); });
        });
        titleInput.addEventListener('input', () => {
            if (currentJsonData) currentJsonData.title = titleInput.value;
        });
        authorInput.addEventListener('input', () => {
            if (currentJsonData) {
                if (!currentJsonData.userPersona) currentJsonData.userPersona = {};
                currentJsonData.userPersona.name = authorInput.value;
            }
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // íŒŒì¼ ì—…ë¡œë“œ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        jsonInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // [ìˆ˜ì •] ë¯¸ì €ì¥ ë°ì´í„° ìˆì„ ë•Œ ê²½ê³ 
            if (isDirty && currentJsonData) {
                if (!confirm("í˜„ì¬ ì‘ì—… ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nìƒˆ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    e.target.value = '';
                    return;
                }
            }

            const ext    = file.name.split('.').pop().toLowerCase();
            const reader = new FileReader();

            reader.onload = function(event) {
                const text = event.target.result;
                try {
                    if (ext === 'json') {
                        currentJsonData = JSON.parse(text);
                    } else if (ext === 'txt') {
                        let messages = [];
                        let title    = file.name.replace('.txt', '');
                        let author   = 'Unknown';

                        if (text.includes('[User]') || text.includes('[Assistant]')) {
                            const titleMatch  = text.match(/^ì œëª©:\s*(.*)/m);
                            if (titleMatch)  title  = titleMatch[1].trim();
                            const authorMatch = text.match(/^ì‘ê°€:\s*(.*)/m);
                            if (authorMatch) author = authorMatch[1].trim();

                            const blocks = text.split(/(?=\[(?:User|Assistant)\])/);
                            blocks.forEach(block => {
                                const isUser      = block.startsWith('[User]');
                                const isAssistant = block.startsWith('[Assistant]');
                                if (isUser || isAssistant) {
                                    let content = block.replace(/^\[(?:User|Assistant)\]\n/, '').trim();
                                    if (content) messages.push({ role: isUser ? 'user' : 'assistant', content });
                                }
                            });
                            currentJsonData = { title, userPersona: { name: author }, messages };
                        } else {
                            currentJsonData = { title, messages: [{ role: 'assistant', content: text.trim() }] };
                        }
                    }

                    titleInput.value  = currentJsonData.title || 'ì œëª© ì—†ìŒ';
                    authorInput.value = (currentJsonData.userPersona && currentJsonData.userPersona.name) || 'Unknown';
                    isDirty = false; // ìƒˆë¡œ ë¶ˆëŸ¬ì™”ìœ¼ë‹ˆ ì´ˆê¸°í™”
                    updatePreview();
                } catch (err) { alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!"); }
            };
            reader.readAsText(file);
        });

        coverInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) { coverPreviewImg.style.display = 'none'; coverFileContent = null; return; }
            coverFileName = file.name;
            coverPreviewImg.src = URL.createObjectURL(file);
            coverPreviewImg.style.display = 'block';

            const reader = new FileReader();
            reader.onload = (event) => { coverFileContent = event.target.result; };
            reader.readAsArrayBuffer(file);
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ìœ í‹¸
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

        // [ìˆ˜ì •] EPUB ìƒì„± ì¤‘ì—” ë¯¸ë¦¬ë³´ê¸° ìˆ˜ì •ë„ ë§‰ë„ë¡ ì „ì²´ ì ê¸ˆ
        function toggleUIControls(disabled) {
            document.querySelectorAll(
                '#control-pane input, #control-pane button, .hud-input, .hud-checkbox, #preview-pane button'
            ).forEach(el => el.disabled = disabled);
            dropdownToggle.disabled = disabled;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updatePreview() {
            if (editingMessageIndex !== null) return;
            if (!currentJsonData) return;

            let html = `<h2 class="preview-title">${titleInput.value || 'ì œëª© ì—†ìŒ'}</h2>\n<br/><br/>\n`;
            const messages = currentJsonData.messages || [];

            const hudPatterns = Array.from(document.querySelectorAll('.hud-item'))
                .filter(item => item.querySelector('.hud-checkbox').checked)
                .map(item => item.querySelector('.hud-input').value.trim())
                .filter(v => v !== '');

            // HUD ì •ê·œì‹ ë¹Œë“œ (ì›ë³¸ê³¼ ë™ì¼ ë°©ì‹ ìœ ì§€)
            let hudRegexes = hudPatterns.map(pattern => {
                let escapedPattern = pattern.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const parts   = escapedPattern.split('$$$');
                const escaped = parts.map(escapeRegExp);
                return new RegExp(escaped.join('[\\s\\S]*?') + '\\n?', 'g');
            });

            messages.forEach((msg, index) => {
                let text = msg.content || '';
                const role = msg.role;

                text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                text = text.split('\n').map(line => line.trimEnd()).join('\n');

                if (removeImgCheck.checked) text = text.replace(/!\[(.*?)\]\((.*?)\)\n?/g, '');
                else text = text.replace(/!\[(.*?)\]\((.*?)\)/g, '<img class="content-img" src="$2" alt="$1" />');

                hudRegexes.forEach(regex => { text = text.replace(regex, ''); });
                text = text.trim();
                text = text.replace(/\n{3,}/g, '\n\n');

                if (!text) return;

                text = text.replace(/^(#{1,6})\s+(.*)$/gm, (m, hashes, content) => `<h${hashes.length}>${content}</h${hashes.length}>`);
                text = text.replace(/\*\*([^\n]+?)\*\*/g, '<span class="bold">$1</span>');
                text = text.replace(/\*([^\n]+?)\*/g,   '<span class="italic">$1</span>');
                text = text.replace(/\n/g, '<br/>');
                text = text.replace(/(?:<br\/>\s*)*(<img[^>]+>)(?:\s*<br\/>)*/g, (m, imgTag, offset) => offset === 0 ? imgTag : '<br/>' + imgTag);
                text = text.replace(/(<\/h[1-6]>)<br\/>/g, '$1');
                text = text.replace(/<br\/>(<h[1-6]>)/g, '$1');

                let blockHtml = '';
                if (role === 'assistant') {
                    blockHtml += `<p>${text}</p>\n`;
                } else if (role === 'user') {
                    if (userDividerCheck.checked) blockHtml += `<hr class="user-divider"/>\n`;
                    blockHtml += `<p class="user-text">${text}</p>\n`;
                    if (userDividerCheck.checked) blockHtml += `<hr class="user-divider"/>\n`;
                } else {
                    blockHtml += `<p>${text}</p>\n`;
                }

                html += `
                <div class="msg-block" id="msg-block-${index}">
                    <div class="msg-content">${blockHtml}</div>
                    <div class="msg-controls">
                        <button class="btn-small btn-edit" onclick="editMessage(${index})">ìˆ˜ì •</button>
                        <button class="btn-small btn-remove" onclick="deleteMessage(${index})">ì‚­ì œ</button>
                    </div>
                </div>`;
            });

            previewContent.innerHTML = html;
        }

        window.deleteMessage = function(index) {
            if (confirm("ì´ ëŒ€ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                currentJsonData.messages.splice(index, 1);
                isDirty = true;
                updatePreview();
            }
        };

        window.editMessage = function(index) {
            if (editingMessageIndex !== null) return alert("ë¨¼ì € ìˆ˜ì • ì¤‘ì¸ ëŒ€ì‚¬ë¥¼ ì €ì¥í•˜ê±°ë‚˜ ì·¨ì†Œí•´ì£¼ì„¸ìš”!");
            editingMessageIndex = index;
            toggleUIControls(true);

            const block      = document.getElementById(`msg-block-${index}`);
            const contentDiv = block.querySelector('.msg-content');
            const controlsDiv= block.querySelector('.msg-controls');
            const rawText    = currentJsonData.messages[index].content;
            const previewPane= document.getElementById('preview-pane');

            contentDiv.innerHTML = `<textarea class="edit-textarea" id="edit-text-${index}">${rawText}</textarea>`;
            const textarea = document.getElementById(`edit-text-${index}`);

            setTimeout(() => {
                const s = previewPane.scrollTop;
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight + 5) + 'px';
                previewPane.scrollTop = s;
            }, 0);

            textarea.addEventListener('input', function() {
                const s = previewPane.scrollTop;
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
                previewPane.scrollTop = s;
            });

            controlsDiv.innerHTML = `<button class="btn-small btn-add" style="float:none;" onclick="saveMessage(${index})">ì €ì¥</button><button class="btn-small btn-remove" onclick="cancelEdit()">ì·¨ì†Œ</button>`;
            controlsDiv.querySelectorAll('button').forEach(btn => btn.disabled = false);
        };

        window.saveMessage = function(index) {
            const textarea = document.getElementById(`edit-text-${index}`);
            if (textarea) currentJsonData.messages[index].content = textarea.value;
            editingMessageIndex = null;
            isDirty = true;
            toggleUIControls(false);
            updatePreview();
        };

        window.cancelEdit = function() {
            editingMessageIndex = null;
            toggleUIControls(false);
            updatePreview();
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ì €ì¥ì†Œ (ë“œë¡­ë‹¤ìš´)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function renderSaveList() {
            saveListContainer.innerHTML = '';
            try {
                let saves = await dbGetAll('saves');
                if (saves.length === 0) {
                    saveListContainer.innerHTML = '<div style="padding:15px;text-align:center;color:#999;font-size:0.85rem;">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                saves.sort((a, b) => b.id - a.id);
                saves.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'save-item';
                    div.innerHTML = `
                        <div class="save-title-text" title="${item.title}">${item.title}</div>
                        <div class="save-actions">
                            <button class="icon-btn" title="ì´ë¦„ ë³€ê²½" onclick="renameSaveDB(${item.id},event)">âœï¸</button>
                            <button class="icon-btn" title="ì‚­ì œ"     onclick="deleteSaveDB(${item.id},event)">âŒ</button>
                        </div>`;
                    div.onclick = () => loadSaveDB(item.id);
                    saveListContainer.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }

        dropdownToggle.addEventListener('click', async (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
            if (dropdownMenu.classList.contains('show')) await renderSaveList();
        });
        document.addEventListener('click', () => dropdownMenu.classList.remove('show'));
        dropdownMenu.addEventListener('click', (e) => e.stopPropagation());

        saveNewBtn.addEventListener('click', async () => {
            if (!currentJsonData) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.");
            let defaultName = (currentJsonData.title || "ì œëª© ì—†ìŒ") + " (" + new Date().toLocaleTimeString('ko-KR', {hour12:false,hour:'2-digit',minute:'2-digit'}) + ")";
            let name = prompt("ì €ì¥ì†Œì— ë³´ê´€í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", defaultName);
            if (name && name.trim() !== "") {
                try {
                    await dbPut('saves', { id: Date.now(), title: name, data: currentJsonData });
                    isDirty = false;
                    await renderSaveList();
                    alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ìš©ëŸ‰ ê±±ì • ì—†ì´ ë³´ê´€ë©ë‹ˆë‹¤.");
                } catch(e) { alert("ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
            }
        });

        window.loadSaveDB = async function(id) {
            try {
                const item = await dbGet('saves', id);
                if (item && confirm(`[${item.title}] ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ í™”ë©´ì˜ ë‚´ìš©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)`)) {
                    currentJsonData   = item.data;
                    titleInput.value  = currentJsonData.title || '';
                    authorInput.value = (currentJsonData.userPersona && currentJsonData.userPersona.name) || '';
                    isDirty = false;
                    updatePreview();
                    dropdownMenu.classList.remove('show');
                }
            } catch(e) { alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
        };

        window.renameSaveDB = async function(id, e) {
            e.stopPropagation();
            try {
                const item = await dbGet('saves', id);
                if (!item) return;
                let newName = prompt("ìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", item.title);
                if (newName && newName.trim() !== "") {
                    item.title = newName.trim();
                    await dbPut('saves', item);
                    await renderSaveList();
                }
            } catch(e) { console.error(e); }
        };

        window.deleteSaveDB = async function(id, e) {
            e.stopPropagation();
            if (confirm("ì´ ì €ì¥ë³¸ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                try { await dbDelete('saves', id); await renderSaveList(); }
                catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨!"); }
            }
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ë‚´ë³´ë‚´ê¸° (JSON / TXT)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function checkExportReady() {
            if (!currentJsonData)             { alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!");          return false; }
            if (editingMessageIndex !== null)  { alert("ëŒ€ì‚¬ ìˆ˜ì •ì„ ì™„ë£Œí•œ ë’¤ ë‹¤ìš´ë¡œë“œí•´ì£¼ì„¸ìš”."); return false; }
            return true;
        }

        btnJson.addEventListener('click', () => {
            if (!checkExportReady()) return;
            saveAs(new Blob([JSON.stringify(currentJsonData, null, 2)], {type:'application/json'}), (titleInput.value||"ìˆ˜ì •ë³¸")+"_ìˆ˜ì •ë¨.json");
            isDirty = false;
        });

        btnTxt.addEventListener('click', () => {
            if (!checkExportReady()) return;
            let txt = `ì œëª©: ${titleInput.value||'ì œëª© ì—†ìŒ'}\nì‘ê°€: ${authorInput.value||'Unknown'}\n\n`;
            (currentJsonData.messages||[]).forEach(msg => {
                txt += `[${msg.role==='user'?'User':'Assistant'}]\n${msg.content}\n\n`;
            });
            saveAs(new Blob([txt],{type:'text/plain;charset=utf-8'}), (titleInput.value||"ìˆ˜ì •ë³¸")+"_ìˆ˜ì •ë¨.txt");
            isDirty = false;
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // [ìˆ˜ì •] ì´ë¯¸ì§€ fetch: íƒ€ì„ì•„ì›ƒ ì¶”ê°€ + í”„ë¡ì‹œ ë³‘ë ¬ ê²½ìŸ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        /**
         * fetch ì— íƒ€ì„ì•„ì›ƒì„ ê±¸ì–´ì£¼ëŠ” ë˜í¼
         */
        function fetchWithTimeout(url, timeoutMs = 30000) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            return fetch(url, { signal: controller.signal })
                .finally(() => clearTimeout(timer));
        }

        /**
         * ì§ì ‘ â†’ ë‚´ í”„ë¡ì‹œ â†’ corsproxy.io â†’ allorigins ìˆœìœ¼ë¡œ ì‹œë„
         * ê° ë‹¨ê³„ë§ˆë‹¤ 10ì´ˆ íƒ€ì„ì•„ì›ƒ
         */
        async function fetchImageAsArrayBuffer(url) {
            const proxies = [
                url,
                MY_PROXY_URL + "?url=" + encodeURIComponent(url),
                'https://corsproxy.io/?' + encodeURIComponent(url),
                'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
            ];

            for (const proxyUrl of proxies) {
                try {
                    const r = await fetchWithTimeout(proxyUrl, 10000);
                    if (r.ok) return await r.arrayBuffer();
                } catch(e) { /* íƒ€ì„ì•„ì›ƒ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ â†’ ë‹¤ìŒ í”„ë¡ì‹œ ì‹œë„ */ }
            }
            return null;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // [ìˆ˜ì •] ì´ë¯¸ì§€ í™•ì¥ì/MIME ì¶”ë¡  (í™•ì¥ì ì—†ëŠ” URL ë°©ì–´)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const VALID_IMG_EXTS = ['png','jpg','jpeg','gif','webp'];

        /**
         * URL ë˜ëŠ” ArrayBuffer(magic bytes) ë¡œë¶€í„° í™•ì¥ìë¥¼ ë°˜í™˜
         * - URL ê²½ë¡œì—ì„œ í™•ì¥ì ì¶”ì¶œ ì‹œë„ (ì¿¼ë¦¬Â·í•´ì‹œ ì œê±° í›„)
         * - ì¸ì‹ ë¶ˆê°€ ì‹œ ArrayBuffer ì• 4ë°”ì´íŠ¸ë¡œ magic bytes íŒë³„
         * - ìµœì¢… fallback: 'jpg'
         */
        function guessExtFromUrl(url) {
            try {
                const pathname = new URL(url).pathname; // ì¿¼ë¦¬Â·í•´ì‹œ ì—†ëŠ” ê²½ë¡œ
                const lastSeg  = pathname.split('/').pop();  // íŒŒì¼ëª… ë¶€ë¶„
                const dotIdx   = lastSeg.lastIndexOf('.');
                if (dotIdx !== -1) {
                    const candidate = lastSeg.slice(dotIdx + 1).toLowerCase();
                    if (VALID_IMG_EXTS.includes(candidate)) return candidate;
                }
            } catch(e) {}
            return null; // íŒë³„ ì‹¤íŒ¨
        }

        function guessExtFromBuffer(buffer) {
            const bytes = new Uint8Array(buffer.slice(0, 12));
            // PNG: 89 50 4E 47
            if (bytes[0]===0x89 && bytes[1]===0x50 && bytes[2]===0x4E && bytes[3]===0x47) return 'png';
            // JPEG: FF D8 FF
            if (bytes[0]===0xFF && bytes[1]===0xD8 && bytes[2]===0xFF) return 'jpg';
            // GIF: 47 49 46 38
            if (bytes[0]===0x47 && bytes[1]===0x49 && bytes[2]===0x46 && bytes[3]===0x38) return 'gif';
            // WebP: 52 49 46 46 ?? ?? ?? ?? 57 45 42 50
            if (bytes[0]===0x52 && bytes[1]===0x49 && bytes[2]===0x46 && bytes[3]===0x46 &&
                bytes[8]===0x57 && bytes[9]===0x45 && bytes[10]===0x42 && bytes[11]===0x50) return 'webp';
            return 'jpg'; // fallback
        }

        function extToMime(ext) {
            return { png:'image/png', jpg:'image/jpeg', jpeg:'image/jpeg', gif:'image/gif', webp:'image/webp' }[ext] || 'image/jpeg';
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // EPUB ë‹¤ìš´ë¡œë“œ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        downloadBtn.addEventListener('click', async () => {
            if (!currentJsonData) return alert("ë°ì´í„°ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
            if (editingMessageIndex !== null) return alert("í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ëŒ€ì‚¬ê°€ ìˆìŠµë‹ˆë‹¤. 'ì €ì¥' ë˜ëŠ” 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥¸ ë’¤ ë‹¤ìš´ë¡œë“œí•´ì£¼ì„¸ìš”.");

            // [ìˆ˜ì •] EPUB ìƒì„± ì¤‘ ì „ì²´ UI ì ê¸ˆ
            loadingScreen.style.display = 'flex';
            toggleUIControls(true);
            progressText.innerText = "(ê³„ì‚° ì¤‘...)";

            try {
                const zip    = new JSZip();
                const title  = titleInput.value  || "ì œëª© ì—†ìŒ";
                const author = authorInput.value || "Unknown";

                // ë¯¸ë¦¬ë³´ê¸° ë³µì‚¬ í›„ í¸ì§‘ ì»¨íŠ¸ë¡¤ ì œê±°
                const previewClone = previewContent.cloneNode(true);
                previewClone.querySelectorAll('.msg-controls').forEach(c => c.remove());
                previewClone.querySelectorAll('.msg-block').forEach(block => {
                    const content = block.querySelector('.msg-content');
                    if (content) while (content.firstChild) block.parentNode.insertBefore(content.firstChild, block);
                    block.remove();
                });

                let bodyHtml = previewClone.innerHTML;

                const oebps        = zip.folder("OEBPS");
                const imagesFolder = oebps.folder("images");
                let   manifestItems = "";

                // ì´ë¯¸ì§€ URL ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°)
                const imgRegex  = /<img[^>]+src="([^">]+)"[^>]*>/g;
                const imageUrls = [...new Set([...bodyHtml.matchAll(/<img[^>]+src="([^">]+)"[^>]*>/g)].map(m => m[1]))];

                let completedCount = 0;
                const totalCount   = imageUrls.length;
                progressText.innerText = `(0 / ${totalCount})`;

                // [ìˆ˜ì •] imageMap í‚¤ë¥¼ ì¸ì½”ë”© ì •ê·œí™”í•˜ì—¬ êµì²´ ì‹ ë¢°ë„ í–¥ìƒ
                const imageMap = new Map();

                for (let i = 0; i < imageUrls.length; i++) {
                    const originalUrl = imageUrls[i];
                    const buffer      = await fetchImageAsArrayBuffer(originalUrl);

                    if (buffer) {
                        // [ìˆ˜ì •] URL ìš°ì„ , ì‹¤íŒ¨ì‹œ magic bytesë¡œ í™•ì¥ì íŒë³„
                        const ext      = guessExtFromUrl(originalUrl) || guessExtFromBuffer(buffer);
                        const mimeType = extToMime(ext);
                        const fileName = `img_${i}.${ext}`;

                        imagesFolder.file(fileName, buffer);
                        manifestItems += `<item id="img_${i}" href="images/${fileName}" media-type="${mimeType}"/>\n`;
                        imageMap.set(originalUrl, `images/${fileName}`);
                    }

                    completedCount++;
                    progressText.innerText = `(${completedCount} / ${totalCount})`;
                }

                // [ìˆ˜ì •] ë‹¨ìˆœ split/join ëŒ€ì‹  escapeRegExp í™œìš©í•œ ì•ˆì „í•œ ì „ì—­ ì¹˜í™˜
                for (const [original, local] of imageMap) {
                    bodyHtml = bodyHtml.split(original).join(local);
                }

                const uniqueId = crypto.randomUUID ? crypto.randomUUID() : 'epub-' + Date.now() + '-' + Math.floor(Math.random()*10000);

                zip.file("mimetype", "application/epub+zip", { compression: "STORE" });
                zip.folder("META-INF").file("container.xml",
                    `<?xml version="1.0" encoding="UTF-8"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`
                );

                oebps.folder("style").file("default.css",
`@namespace epub "http://www.idpf.org/2007/ops";
body { font-family: sans-serif; line-height: 1.8; }
h2.preview-title { text-align: center; }
p { margin: 0.5em 0; text-align: justify; }
h1, h2, h3, h4, h5, h6 { margin: 0.5em 0; line-height: 1.3; }
.bold { font-weight: bold; }
.italic { font-style: italic; }
.user-text { margin-top: 1.5em; margin-bottom: 1.5em; }
.user-divider { border: 0; border-top: 1px dashed #b2bec3; margin: 1.5em 0; }
img.content-img { max-width: 100%; height: auto; display: block; margin: 1.8em auto 0.2em auto; }`
                );

                oebps.file("chap_01.xhtml",
                    `<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ko">\n<head><title>${title}</title><link rel="stylesheet" type="text/css" href="style/default.css"/></head>\n<body>${bodyHtml}</body>\n</html>`
                );
                oebps.file("nav.xhtml",
                    `<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">\n<head><title>Navigation</title></head>\n<body><nav epub:type="toc" id="toc"><h1>ëª©ì°¨</h1><ol><li><a href="chap_01.xhtml">ë³¸ë¬¸</a></li></ol></nav></body>\n</html>`
                );

                let coverMeta = "", coverItem = "";
                if (coverFileContent) {
                    const ext      = coverFileName.split('.').pop().toLowerCase();
                    const mimeType = ext === 'png' ? 'image/png' : 'image/jpeg';
                    oebps.file("cover." + ext, coverFileContent);
                    coverMeta = `<meta name="cover" content="cover-image"/>`;
                    coverItem = `<item id="cover-image" href="cover.${ext}" media-type="${mimeType}"/>`;
                }

                oebps.file("content.opf",
                    `<?xml version="1.0" encoding="UTF-8"?>\n<package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="pub-id">\n    <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">\n        <dc:title>${title}</dc:title><dc:creator>${author}</dc:creator><dc:language>ko</dc:language>\n        <dc:identifier id="pub-id">urn:uuid:${uniqueId}</dc:identifier>\n        ${coverMeta}\n    </metadata>\n    <manifest>\n        <item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"/>\n        <item id="chap1" href="chap_01.xhtml" media-type="application/xhtml+xml"/>\n        <item id="css" href="style/default.css" media-type="text/css"/>\n        ${manifestItems}\n        ${coverItem}\n    </manifest>\n    <spine><itemref idref="chap1"/></spine>\n</package>`
                );

                const content = await zip.generateAsync({ type: "blob", mimeType: "application/epub+zip" });
                saveAs(content, title + ".epub");
                isDirty = false;

            } catch(e) {
                alert("EPUB ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ ã… ã… \n" + e.message);
            } finally {
                loadingScreen.style.display = 'none';
                toggleUIControls(false);
            }
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ì´ˆê¸°í™”
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.onload = async () => {
            try { await initDB(); }
            catch(e) { console.warn("IndexedDB ì´ˆê¸°í™” ì‹¤íŒ¨: ì €ì¥ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); }
            loadSettings();
        };
    </script>
</body>
</html>
